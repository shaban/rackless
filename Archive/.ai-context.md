# AI Assistant Context - MC-SoFX Controller Project

**Project**: Neural DSP AudioUnit Plugin Controller  
**Language Stack**: Go + Objective-C via CGO  
**Platform**: macOS (Darwin) with AudioUnit framework  
**Last Updated**: 2025-07-29

## 🏗️ **CRITICAL ARCHITECTURE CHANGE: CGO Integration**

### **Revolutionary Migration Completed**
- **From**: External process calls (`exec.Command` to separate Objective-C tools)
- **To**: Direct native function calls via CGO integration
- **Result**: Eliminated all external dependencies, V2Bridge crashes, and symbol conflicts

### **Current CGO Architecture**
```
pkg/introspection/                  pkg/hosting/
├── introspection.go               ├── hosting.go  
├── audiounit_inspector.h          ├── audiounit_host.h
├── audiounit_inspector.m          ├── audiounit_host.m
└── libaudiounit_inspector.a       └── libaudiounit_host.a
```

**Key Pattern**: Objective-C implementation files live as **siblings** to Go files in same package
**Build Success**: No duplicate symbol conflicts despite C code next to CGO Go code

## 🔧 **CGO Integration Details**

### **pkg/introspection/introspection.go**
```go
//go:build darwin && cgo

/*
#cgo CFLAGS: -x objective-c
#cgo LDFLAGS: -L. -laudiounit_inspector -lobjc -framework Foundation -framework AudioToolbox -framework AVFoundation -framework AudioUnit
#include <stdlib.h>
#include "audiounit_inspector.h"
*/
import "C"

// Direct native call - no external process
func GetIntrospectionJSON() string {
    cstr := C.IntrospectAudioUnits()
    if cstr == nil { return "" }
    str := C.GoString(cstr)
    C.free(unsafe.Pointer(cstr))
    return str
}
```

### **pkg/hosting/hosting.go**
```go
/*
#cgo CFLAGS: -I.
#cgo LDFLAGS: -L. -laudiounit_host -framework Foundation -framework AudioToolbox -framework AVFoundation -framework AudioUnit -framework CoreAudio
#include "audiounit_host.h"
*/
import "C"
```

## 📊 **Current Data Flow (Post-CGO)**

```
User Request → Go Server → CGO Call → Native Objective-C → AudioUnit Framework → Return JSON → Go Processing → HTTP Response
```

**Example**:
```
HTTP GET /api/parameters 
    ↓
selectedPlugin := introspectionResult.SelectBestPluginForLayout()
    ↓  
Returns: Neural DSP parameters with IndexedValues for radio buttons
```

## 🎛️ **Plugin Data Structure (Multi-Plugin Support)**

### **Global State**
```go
var IntrospectionData = make([]Plugin, 0)  // Array of ALL plugins (157+)

type Plugin struct {
    Name:           "Neural DSP: Morgan Amps Suite"
    ManufacturerID: "NDSP" 
    Type:           "aufx"  // or "aumf"
    Subtype:        "NMAS"  // Unique 4-char identifier
    Parameters:     []Parameter  // 128 parameters for NDSP
}
```

### **Plugin Selection Logic (CRITICAL)**
```go
SelectBestPluginForLayout():
1. Priority: First NDSP plugin with parameters
2. Fallback: First plugin with parameters  
3. Never returns plugins without parameters
```

### **Parameter Structure (UI Critical)**
```go
type Parameter struct {
    Address:       112                        // Unique identifier
    DisplayName:   "Delay Sync Mode"          // UI label  
    Unit:          "Indexed"                  // "Boolean", "Generic", "Indexed"
    IndexedValues: ["DAW", "Free", "Tap"]     // For radio buttons/dropdowns
    MinValue:      0.0
    MaxValue:      1.0 
    DefaultValue:  1.0
    CurrentValue:  1.0
}
```

## 🌐 **Server API Endpoints (Active)**

### **Core Endpoints**
```go
GET  /api/parameters        // Current selected plugin's 128 parameters
GET  /api/plugins          // All 157+ discovered plugins with component info
GET  /api/layouts/{name}    // Layout definition for UI rendering
PUT  /api/layouts/{name}    // Update layout configuration
```

### **Plugin Component Data**
```json
{
  "type": "aumf",           // AudioUnit type
  "subtype": "NMAS",        // Unique plugin identifier
  "manufacturer": "NDSP",   // Manufacturer code
  "name": "Neural DSP: Morgan Amps Suite"
}
```

## 🎸 **Current Working Features**

### **✅ AudioUnit Introspection**
- **157+ plugins discovered** from all manufacturers (Apple, iZotope, Neural DSP, etc.)
- **Parameter extraction**: 128 Neural DSP parameters with full metadata
- **Indexed values**: Radio button options like ["DAW", "Free", "Tap"]  
- **No external processes**: Direct CGO native calls
- **No crashes**: V2Bridge issues eliminated

### **✅ Web Interface**
- **Dynamic layouts**: Generated from plugin parameters
- **Radio buttons**: Working with IndexedValues from parameters
- **Stepped sliders**: For discrete parameter values
- **CSS theming**: Custom properties for consistent styling
- **Real-time updates**: Parameter changes reflected in UI

### **✅ Audio Processing (CGO)**
- **Real-time audio**: Input → AudioUnit → Output routing
- **Parameter control**: Live parameter changes during playback
- **Plugin loading**: Native AudioUnit instantiation  
- **Audio metering**: Level monitoring and taps
- **No V2Bridge crashes**: Stable plugin hosting

## 🚨 **Issues Resolved (Historical Context)**

### **❌ Old Problems (Eliminated by CGO Migration)**
- External process execution (`exec.Command`) 
- JSON file I/O for inter-process communication
- V2Bridge AudioUnit crashes when loading plugins
- Symbol duplication conflicts between C and CGO code
- Single-plugin limitation (only Neural DSP)
- File path-based plugin addressing (unreliable)
- Process management complexity

### **✅ Current Solutions**
- Direct CGO native function calls
- In-memory JSON string processing  
- Stable AudioUnit introspection and hosting
- Clean package-local C/Objective-C code with no conflicts
- Multi-plugin scanning and support (157+ plugins)
- Component-based addressing (type/subtype/manufacturer)
- Single integrated Go binary

## 🧪 **Testing Context (Recent Work Before Outage)**

**Last Session Focus**: Writing Go tests for `cmd/server/` endpoints
- **Goal**: Test CGO integration paths in server handlers
- **Focus Areas**: Parameter retrieval, plugin selection logic, layout generation
- **Interrupted By**: GitHub outage during test development session
- **Current Need**: Resume test development for server endpoints

### **Test Patterns to Implement**
```go
func TestHandleGetParameters(t *testing.T) {
    // Test SelectBestPluginForLayout() with CGO data
    // Verify IndexedValues for radio buttons
    // Ensure 128 parameters returned for NDSP plugin
}

func TestHandleListPlugins(t *testing.T) {
    // Test 157+ plugins returned
    // Verify component data (type/subtype/manufacturer)
    // Check filtering (only plugins with parameters)
}
```

## 🔍 **Code Patterns to Remember**

### **CGO Memory Management**
```go
// Always use this pattern for C string returns
cstr := C.SomeNativeFunction()
if cstr == nil { return "" }
str := C.GoString(cstr)
C.free(unsafe.Pointer(cstr))  // Critical: free C memory
return str
```

### **Plugin Selection (Always Use This)**
```go
// Consistent plugin selection across all handlers
introspectionResult := introspection.IntrospectionResult(introspection.IntrospectionData)
selectedPlugin := introspectionResult.SelectBestPluginForLayout()
if selectedPlugin == nil { /* error handling */ }
```

### **Build Constraints (Required)**
```go
//go:build darwin && cgo
// Required for all CGO AudioUnit packages
```

## 📁 **Project Structure (Current)**

```
MC-SoFX-Controller/
├── pkg/
│   ├── introspection/          # CGO AudioUnit discovery
│   │   ├── introspection.go    # Go interface + CGO calls
│   │   ├── audiounit_inspector.h/.m  # Native implementation
│   │   └── libaudiounit_inspector.a  # Compiled library
│   ├── hosting/                # CGO Audio processing  
│   │   ├── hosting.go          # Go interface + CGO calls
│   │   ├── audiounit_host.h/.m # Native implementation
│   │   └── libaudiounit_host.a # Compiled library
│   └── layout/                 # Pure Go layout system
├── cmd/server/                 # HTTP server with CGO integration
├── frontend/                   # Vue.js UI with radio buttons
└── data/                       # JSON layouts and parameters
```

## 🎯 **Success Metrics (Current State)**

- **Plugin Discovery**: 157+ AudioUnits successfully introspected
- **Audio Quality**: Real-time processing with no V2Bridge crashes
- **Architecture**: Clean CGO integration with no symbol conflicts  
- **Performance**: Direct native calls eliminate external process overhead
- **Stability**: No crashes during plugin loading or parameter access
- **Flexibility**: Universal AudioUnit support (not just Neural DSP)

## 🚀 **Next Development Priorities**

1. **Testing**: Complete Go tests for server endpoints (interrupted work)
2. **UI Verification**: Confirm radio buttons work with new CGO parameter data
3. **Integration Testing**: End-to-end tests with actual AudioUnit loading
4. **Performance**: CGO call optimization if needed

## 💡 **AI Assistant Guidance**

### **When Debugging CGO Issues**
- Check build constraints (`//go:build darwin && cgo`)
- Verify static library linking (`-laudiounit_inspector`)
- Confirm memory management (C.free for C strings)
- Validate framework dependencies

### **When Working with Plugins** 
- Always use `SelectBestPluginForLayout()` for consistency
- Check `len(plugin.Parameters) > 0` before processing
- Remember IndexedValues are for radio buttons/dropdowns
- NDSP plugins get priority in selection

### **When Testing**
- Test CGO integration paths specifically  
- Verify 157+ plugins are discovered
- Confirm NDSP plugin selection works
- Test parameter data structure integrity

---

*This context enables AI assistants to immediately understand the current CGO-based architecture, recent changes, and development priorities without needing to rebuild understanding from scratch.*
